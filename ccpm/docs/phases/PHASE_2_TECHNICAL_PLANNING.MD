# Phase 2: Technical Planning - Detailed Guidelines

**Phase:** 2/9 - Technical Planning & Architecture  
**Duration:** 1-2 days  
**Agents:** mobile-react-native, web-*, backend-laravel, pm-operations-orchestrator  
**Prerequisites:** Phase 1 approved  
**Deliverables:** tech_spec.md, architecture_diagram.drawio, lld.md, api_contracts.md

---

## ðŸŽ¯ Phase Objectives

1. **Design** system architecture and component structure
2. **Define** technical approach and tech stack
3. **Document** APIs, interfaces, and data models
4. **Create** architecture diagrams and flow charts
5. **Estimate** technical effort and identify challenges

---

## ðŸ“‹ Step-by-Step Process

### Step 1: System Architecture (30 min)

#### 1.1 High-Level Architecture

**Action:** Design system components and their interactions

**Questions to answer:**
```markdown
Architecture Questions:
- What layers does the system have? (UI, Business Logic, Data)
- What external services are involved?
- How do components communicate?
- What's the data flow?
- Where is state managed?
- How is authentication handled?
```

**Template:**
```markdown
## System Architecture

### Component Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           Mobile App (React Native)      â”‚
â”‚                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚   UI     â”‚  â”‚ Business â”‚  â”‚  Data  â”‚â”‚
â”‚  â”‚  Layer   â”‚â†â†’â”‚  Logic   â”‚â†â†’â”‚ Layer  â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚       â†“              â†“            â†“     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”˜
        â”‚              â”‚            â”‚
        â†“              â†“            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         External Services                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚Facebookâ”‚  â”‚ Instagram â”‚  â”‚   AWS    â”‚ â”‚
â”‚  â”‚   API  â”‚  â”‚    API    â”‚  â”‚    S3    â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Component Breakdown

#### UI Layer
- **ShareModal** - Main sharing interface
- **PlatformSelector** - Choose Facebook/Instagram
- **ContentEditor** - Edit text/image
- **PreviewScreen** - Preview before post

#### Business Logic Layer
- **ShareService** - Orchestrates sharing flow
- **AuthService** - Handle OAuth tokens
- **ImageService** - Compress/resize images
- **ValidationService** - Validate input

#### Data Layer
- **ShareRepository** - API calls
- **TokenStorage** - Secure token storage
- **CacheManager** - Cache shared content

### External Dependencies
- Facebook SDK v16.x
- Instagram Graph API
- AWS S3 for image hosting
- Analytics SDK
```

---

#### 1.2 Technology Stack

**Action:** Define frameworks, libraries, tools

**Template:**
```markdown
## Technology Stack

### Frontend (Mobile)
```yaml
Platform: React Native 0.76.9
Language: TypeScript 5.3
State: Zustand 4.3.6 + Immer
Forms: React Hook Form 7.43.5
Validation: Yup
Navigation: React Navigation 6.x
UI: proj-ui-components
```

### SDKs & Libraries
```yaml
Social:
  - react-native-fbsdk-next: ^12.0.0
  - react-native-instagram: Custom (Graph API)
  
Image:
  - react-native-image-picker: ^5.0.0
  - react-native-image-resizer: ^3.0.0
  
Storage:
  - @react-native-async-storage/async-storage: ^1.19.0
  - react-native-keychain: ^8.1.0 (tokens)
  
Network:
  - axios: ^1.6.0
  - @tanstack/react-query: ^4.26.1
```

### Backend APIs
```yaml
Backend API:
  - POST /api/v1/social/share
  - GET /api/v1/social/history
  - POST /api/v1/social/upload-image
  
Facebook API:
  - POST /me/feed (share to feed)
  - POST /me/photos (share with image)
  
Instagram API:
  - POST /me/media (create media)
  - POST /me/media_publish (publish)
```

### Development Tools
```yaml
Testing:
  - Jest + jest-expo
  - React Native Testing Library
  - Mock Service Worker (MSW)
  
Linting:
  - ESLint
  - Prettier
  - TypeScript strict mode
  
Build:
  - EAS Build
  - Expo 52.x
```
```

---

### Step 2: Component Design (45 min)

#### 2.1 Component Tree

**Action:** Break down UI into component hierarchy

**Template:**
```markdown
## Component Hierarchy

```
ShareFeature/
â”‚
â”œâ”€â”€ ShareModal (Container)
â”‚   â”œâ”€â”€ ShareHeader
â”‚   â”‚   â””â”€â”€ CloseButton
â”‚   â”‚
â”‚   â”œâ”€â”€ PlatformSelector
â”‚   â”‚   â”œâ”€â”€ PlatformOption (Facebook)
â”‚   â”‚   â”œâ”€â”€ PlatformOption (Instagram)
â”‚   â”‚   â””â”€â”€ PlatformOption (LinkedIn)
â”‚   â”‚
â”‚   â”œâ”€â”€ ContentEditor
â”‚   â”‚   â”œâ”€â”€ ImagePicker
â”‚   â”‚   â”‚   â”œâ”€â”€ GalleryButton
â”‚   â”‚   â”‚   â”œâ”€â”€ CameraButton
â”‚   â”‚   â”‚   â””â”€â”€ ImagePreview
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ TextInput
â”‚   â”‚   â”‚   â”œâ”€â”€ CharacterCount (500/500)
â”‚   â”‚   â”‚   â””â”€â”€ EmojiPicker
â”‚   â”‚   â”‚
â”‚   â”‚   â””â”€â”€ Validation (inline errors)
â”‚   â”‚
â”‚   â”œâ”€â”€ PreviewSection
â”‚   â”‚   â”œâ”€â”€ PlatformPreview (Facebook)
â”‚   â”‚   â””â”€â”€ PlatformPreview (Instagram)
â”‚   â”‚
â”‚   â””â”€â”€ ShareFooter
â”‚       â”œâ”€â”€ CancelButton
â”‚       â””â”€â”€ ShareButton (primary)
â”‚
â””â”€â”€ ShareSuccessModal
    â”œâ”€â”€ SuccessIcon
    â”œâ”€â”€ Message
    â””â”€â”€ CloseButton
```

---

#### 2.2 Component Specifications

**For each key component:**

```markdown
### Component: ShareModal

**File:** `src/features/sharing/ShareModal.tsx`

**Type:** Container Component (Smart)

**Props:**
```typescript
interface ShareModalProps {
  visible: boolean;
  onClose: () => void;
  initialContent?: {
    text?: string;
    imageUri?: string;
  };
  successStoryId?: string;
}
```

**State:**
```typescript
interface ShareModalState {
  selectedPlatform: 'facebook' | 'instagram' | 'linkedin';
  content: {
    text: string;
    imageUri: string | null;
  };
  isSubmitting: boolean;
  errors: Record<string, string>;
}
```

**Responsibilities:**
- Orchestrate sharing flow
- Manage form state
- Validate input
- Call share API
- Handle success/error

**Dependencies:**
- `useSocialMediaShare` hook
- `useImagePicker` hook
- `useForm` (react-hook-form)
- `ShareService`

**Testing Strategy:**
- Unit tests for logic
- Integration tests for user flow
- Snapshot tests for UI

---

### Component: PlatformSelector

**File:** `src/features/sharing/components/PlatformSelector.tsx`

**Type:** Presentational Component

**Props:**
```typescript
interface PlatformSelectorProps {
  selectedPlatform: Platform;
  onSelect: (platform: Platform) => void;
  availablePlatforms: Platform[];
}
```

**Responsibilities:**
- Display platform options
- Handle platform selection
- Show active state

**No State** - Controlled component
```

---

#### 2.3 Data Flow Design

**Action:** Document how data flows through the system

**Template:**
```markdown
## Data Flow

### 1. User Initiates Share
```
User clicks "Share"
    â†“
ShareModal opens
    â†“
Load user preferences (last used platform)
    â†“
Pre-fill content if provided
    â†“
Show UI
```

### 2. User Selects Platform
```
User clicks "Facebook"
    â†“
Update selectedPlatform state
    â†“
Load platform-specific options
    â†“
Show Facebook preview
```

### 3. User Picks Image
```
User clicks "Pick Image"
    â†“
Check gallery permission
    â†“  (if denied)
    â””â”€â†’ Request permission
        â†“  (if granted)
Open ImagePicker
    â†“
User selects image
    â†“
Compress image (if > 5MB)
    â†“
Update imageUri state
    â†“
Show image preview
```

### 4. User Submits Share
```
User clicks "Share"
    â†“
Validate form (text, image)
    â†“  (if invalid)
    â””â”€â†’ Show validation errors
        â†“
Check network connection
    â†“  (if offline)
    â””â”€â†’ Show offline error
        â†“
Set isSubmitting = true
    â†“
Upload image to S3
    â†“
Get image URL
    â†“
Call Facebook API
    â†“
Save share record to YOUR API
    â†“
Set isSubmitting = false
    â†“
Show success modal
    â†“
Track analytics event
    â†“
Close modal
```

### 5. Error Handling
```
API call fails
    â†“
Check error type:
    â”œâ”€â†’ Network error â†’ Show "Check connection"
    â”œâ”€â†’ Token expired â†’ Refresh token, retry
    â”œâ”€â†’ Rate limit â†’ Show "Try again later"
    â””â”€â†’ Other â†’ Show generic error
        â†“
Log error to analytics
    â†“
Set isSubmitting = false
    â†“
Keep modal open for retry
```
```

---

### Step 3: API Design (30 min)

#### 3.1 API Contracts

**Action:** Define all API endpoints and payloads

**Template:**
```markdown
## API Contracts

### 1. Upload Image

**Endpoint:** `POST /api/v1/social/upload-image`

**Request:**
```typescript
// Headers
{
  'Authorization': 'Bearer {token}',
  'Content-Type': 'multipart/form-data'
}

// Body
FormData {
  image: File,
  compress: boolean = true
}
```

**Response (200):**
```json
{
  "success": true,
  "data": {
    "imageUrl": "https://cdn.example.com/images/abc123.jpg",
    "imageId": "img_abc123",
    "size": 1024000,
    "dimensions": {
      "width": 1080,
      "height": 1080
    }
  }
}
```

**Response (400):**
```json
{
  "success": false,
  "error": {
    "code": "IMAGE_TOO_LARGE",
    "message": "Image exceeds 10MB limit",
    "details": {
      "maxSize": 10485760,
      "actualSize": 15728640
    }
  }
}
```

---

### 2. Share to Platform

**Endpoint:** `POST /api/v1/social/share`

**Request:**
```typescript
{
  "platform": "facebook" | "instagram" | "linkedin",
  "content": {
    "text": string,
    "imageUrl": string | null,
    "successStoryId": string | null
  },
  "metadata": {
    "deviceType": "phone" | "tablet",
    "region": "ph" | "my" | "id" | "ib" | "hk"
  }
}
```

**Response (200):**
```json
{
  "success": true,
  "data": {
    "shareId": "share_xyz789",
    "platformPostId": "fb_123456",
    "postedAt": "2025-11-23T10:30:00Z",
    "postUrl": "https://facebook.com/123456"
  }
}
```

---

### 3. Get Share History

**Endpoint:** `GET /api/v1/social/history?limit=20&offset=0`

**Response:**
```json
{
  "success": true,
  "data": {
    "shares": [
      {
        "id": "share_xyz789",
        "platform": "facebook",
        "content": {
          "text": "Just closed a big deal!",
          "imageUrl": "https://..."
        },
        "postedAt": "2025-11-23T10:30:00Z",
        "engagement": {
          "likes": 42,
          "comments": 5,
          "shares": 3
        }
      }
    ],
    "pagination": {
      "total": 50,
      "limit": 20,
      "offset": 0
    }
  }
}
```
```

---

#### 3.2 Third-Party API Integration

**Template:**
```markdown
## Facebook API Integration

### Share to Feed
**Endpoint:** `POST /v16.0/me/feed`

**Request:**
```typescript
{
  access_token: string,
  message: string,
  link?: string,
  picture?: string
}
```

### Error Handling
```typescript
Facebook Error Codes:
- 190: Token expired â†’ Refresh token
- 368: Temporarily blocked â†’ Backoff
- 4: Rate limit â†’ Queue for later
- 200: Permission denied â†’ Re-auth
```

---

## Instagram API Integration

### Create Media Container
**Endpoint:** `POST /v16.0/me/media`

**Two-step process:**
```typescript
// Step 1: Create container
POST /me/media {
  image_url: string,
  caption: string
}
â†’ Returns: { id: "media_container_id" }

// Step 2: Publish
POST /me/media_publish {
  creation_id: "media_container_id"
}
â†’ Returns: { id: "published_media_id" }
```
```

---

### Step 4: Database & Storage (20 min)

#### 4.1 Data Models

**Template:**
```markdown
## Data Models

### Zustand Store: ShareSlice

**File:** `src/utils/zustand/shareSlice.ts`

```typescript
interface ShareSlice {
  // State
  recentShares: Share[];
  draftShares: DraftShare[];
  shareHistory: ShareHistoryItem[];
  
  // Actions
  addShare: (share: Share) => void;
  saveDraft: (draft: DraftShare) => void;
  loadDrafts: () => Promise<void>;
  getShareById: (id: string) => Share | null;
  clearHistory: () => void;
}

interface Share {
  id: string;
  platform: Platform;
  content: {
    text: string;
    imageUri: string | null;
  };
  postedAt: Date;
  status: 'pending' | 'success' | 'failed';
  error?: string;
}

interface DraftShare {
  id: string;
  platform: Platform;
  content: Partial<ShareContent>;
  savedAt: Date;
}
```

---

### AsyncStorage Schema

```typescript
Keys:
  @share:drafts â†’ DraftShare[]
  @share:history â†’ ShareHistoryItem[]
  @share:settings â†’ ShareSettings
  
Storage Limits:
  - Drafts: Max 10 (FIFO)
  - History: Max 100 (FIFO)
  - Settings: Single object
```

---

### Keychain (Secure Storage)

```typescript
Keys:
  @tokens:facebook â†’ { accessToken, expiresAt }
  @tokens:instagram â†’ { accessToken, expiresAt }
  @tokens:linkedin â†’ { accessToken, expiresAt }
  
Security:
  - iOS: Keychain Services
  - Android: Keystore
  - Encrypted at rest
  - Biometric optional
```
```

---

### Step 5: Architecture Diagram (30 min)

#### 5.1 Create Draw.io Diagram

**Action:** Visual architecture using Draw.io

**Diagrams to create:**

1. **System Architecture Diagram**
```
Components:
- Mobile App (client)
- YOUR API (backend)
- Facebook API
- Instagram API
- AWS S3
- Analytics

Show:
- Data flow arrows
- Authentication flow
- Error handling paths
```

2. **Component Diagram**
```
- UI Components tree
- State management (Zustand)
- Services layer
- API clients
```

3. **Sequence Diagram - Happy Path**
```
User â†’ ShareModal â†’ ShareService â†’ Facebook API â†’ Success
```

4. **Sequence Diagram - Error Path**
```
User â†’ ShareModal â†’ ShareService â†’ Facebook API â†’ Error â†’ Retry Logic
```

**Save as:** `docs/phases/diagrams/phase-2-architecture.drawio`

---

### Step 6: Low-Level Design (LLD) (45 min)

#### 6.1 Create LLD Document

**Template:**
```markdown
# Low-Level Design: Social Media Sharing

## 1. Module Structure

```
src/features/sharing/
â”œâ”€â”€ ShareModal.tsx                 # Main container
â”œâ”€â”€ ShareModal.phone.tsx           # Phone implementation
â”œâ”€â”€ ShareModal.tablet.tsx          # Tablet implementation
â”‚
â”œâ”€â”€ components/
â”‚   â”œâ”€â”€ PlatformSelector.tsx
â”‚   â”œâ”€â”€ ContentEditor.tsx
â”‚   â”œâ”€â”€ ImagePicker.tsx
â”‚   â””â”€â”€ PreviewSection.tsx
â”‚
â”œâ”€â”€ hooks/
â”‚   â”œâ”€â”€ useSocialMediaShare.tsx    # Main hook
â”‚   â”œâ”€â”€ useImagePicker.tsx
â”‚   â”œâ”€â”€ usePlatformAuth.tsx
â”‚   â””â”€â”€ useShareValidation.tsx
â”‚
â”œâ”€â”€ services/
â”‚   â”œâ”€â”€ ShareService.ts            # Business logic
â”‚   â”œâ”€â”€ FacebookService.ts
â”‚   â”œâ”€â”€ InstagramService.ts
â”‚   â””â”€â”€ ImageService.ts
â”‚
â”œâ”€â”€ api/
â”‚   â””â”€â”€ shareApi.ts                # API client
â”‚
â”œâ”€â”€ types/
â”‚   â””â”€â”€ share.types.ts
â”‚
â”œâ”€â”€ utils/
â”‚   â”œâ”€â”€ validation.ts
â”‚   â””â”€â”€ imageCompression.ts
â”‚
â””â”€â”€ __tests__/
    â”œâ”€â”€ ShareModal.test.tsx
    â”œâ”€â”€ useSocialMediaShare.test.tsx
    â””â”€â”€ ShareService.test.ts
```

---

## 2. Key Algorithms

### Image Compression Algorithm

```typescript
/**
 * Compress image to target size while maintaining quality
 * 
 * @param imageUri - Local image URI
 * @param maxSizeMB - Maximum size in MB (default: 5)
 * @param maxWidth - Maximum width in pixels (default: 1080)
 * @returns Compressed image URI
 */
async function compressImage(
  imageUri: string,
  maxSizeMB: number = 5,
  maxWidth: number = 1080
): Promise<string> {
  // 1. Get image dimensions
  const { width, height } = await getImageSize(imageUri);
  
  // 2. Calculate scale ratio
  const scale = Math.min(1, maxWidth / width);
  
  // 3. Resize if needed
  if (scale < 1) {
    imageUri = await ImageResizer.createResizedImage(
      imageUri,
      maxWidth,
      height * scale,
      'JPEG',
      80 // Initial quality
    );
  }
  
  // 4. Check size, reduce quality if needed
  let quality = 80;
  while (await getFileSizeMB(imageUri) > maxSizeMB && quality > 20) {
    quality -= 10;
    imageUri = await ImageResizer.createResizedImage(
      imageUri,
      maxWidth,
      height * scale,
      'JPEG',
      quality
    );
  }
  
  return imageUri;
}
```

---

### Share Retry Logic

```typescript
/**
 * Retry share with exponential backoff
 * 
 * Max retries: 3
 * Backoff: 1s, 2s, 4s
 */
async function shareWithRetry(
  platform: Platform,
  content: ShareContent,
  maxRetries: number = 3
): Promise<ShareResult> {
  for (let attempt = 0; attempt < maxRetries; attempt++) {
    try {
      return await shareToPlat form(platform, content);
    } catch (error) {
      // Don't retry on validation errors
      if (error.code === 'VALIDATION_ERROR') {
        throw error;
      }
      
      // Don't retry on permission errors
      if (error.code === 'PERMISSION_DENIED') {
        throw error;
      }
      
      // Last attempt, throw error
      if (attempt === maxRetries - 1) {
        throw error;
      }
      
      // Wait before retry (exponential backoff)
      const delay = Math.pow(2, attempt) * 1000;
      await sleep(delay);
    }
  }
}
```

---

## 3. State Management

### Zustand Slice Implementation

```typescript
export const createShareSlice: StateCreator<ShareSlice> = (set, get) => ({
  recentShares: [],
  draftShares: [],
  
  addShare: (share) => set((state) => ({
    recentShares: [share, ...state.recentShares].slice(0, 10)
  })),
  
  saveDraft: async (draft) => {
    set((state) => ({
      draftShares: [draft, ...state.draftShares].slice(0, 10)
    }));
    
    // Persist to AsyncStorage
    await AsyncStorage.setItem(
      '@share:drafts',
      JSON.stringify(get().draftShares)
    );
  },
  
  // ... more actions
});
```

---

## 4. Error Handling Strategy

```typescript
enum ShareErrorCode {
  NETWORK_ERROR = 'NETWORK_ERROR',
  TOKEN_EXPIRED = 'TOKEN_EXPIRED',
  RATE_LIMIT = 'RATE_LIMIT',
  VALIDATION_ERROR = 'VALIDATION_ERROR',
  PERMISSION_DENIED = 'PERMISSION_DENIED',
  UNKNOWN = 'UNKNOWN',
}

interface ShareError {
  code: ShareErrorCode;
  message: string;
  details?: any;
  retryable: boolean;
}

function handleShareError(error: any): ShareError {
  // Map API errors to ShareError
  if (error.response?.status === 401) {
    return {
      code: ShareErrorCode.TOKEN_EXPIRED,
      message: 'Please login again',
      retryable: true,
    };
  }
  
  if (error.response?.status === 429) {
    return {
      code: ShareErrorCode.RATE_LIMIT,
      message: 'Too many requests. Please try again later.',
      retryable: true,
    };
  }
  
  if (!error.response) {
    return {
      code: ShareErrorCode.NETWORK_ERROR,
      message: 'No internet connection',
      retryable: true,
    };
  }
  
  return {
    code: ShareErrorCode.UNKNOWN,
    message: 'Something went wrong',
    details: error.message,
    retryable: false,
  };
}
```
```

---

### Step 7: Performance Considerations (15 min)

**Template:**
```markdown
## Performance Optimization

### Image Handling
```yaml
Strategy:
  - Compress images before upload (target: < 5MB)
  - Use progressive JPEG format
  - Cache compressed images (max 24h)
  - Cancel uploads if user closes modal
  
Metrics:
  - Target: Compression in < 2s
  - Upload: < 5s on 4G
```

### API Calls
```yaml
Strategy:
  - Use React Query for caching
  - Debounce validation calls (300ms)
  - Prefetch user preferences
  - Retry failed requests (3 attempts)
  
Metrics:
  - Cache hit rate: > 70%
  - API response: < 1s
```

### UI Responsiveness
```yaml
Strategy:
  - Show loading states immediately
  - Use optimistic UI updates
  - Lazy load heavy components
  - Use React.memo for pure components
  
Metrics:
  - UI update: < 16ms (60fps)
  - Modal open: < 300ms
```
```

---

### Step 8: Security Considerations (15 min)

**Template:**
```markdown
## Security

### Token Management
```yaml
Storage:
  - Facebook tokens in Keychain (encrypted)
  - Never log tokens
  - Auto-refresh before expiry
  
Rotation:
  - Refresh tokens every 30 days
  - Revoke on logout
  - Handle refresh failures gracefully
```

### Data Protection
```yaml
User Content:
  - Validate all input (XSS prevention)
  - Sanitize text before API calls
  - No PII in analytics events
  
Image Upload:
  - Scan for malware (backend)
  - Strip EXIF data (location, camera info)
  - Validate MIME type
```

### API Security
```yaml
Requests:
  - HTTPS only
  - Token in Authorization header
  - CSRF protection
  - Rate limiting (client-side)
```
```

---

### Step 9: Documentation & Approval (20 min)

#### 9.1 Generate Tech Spec

**Action:** Consolidate all above into tech_spec.md

**Use template:** `templates/tech-spec.md`

**Sections:**
1. Executive Summary
2. System Architecture
3. Component Design
4. API Contracts
5. Data Models
6. Performance
7. Security
8. Risks & Mitigations
9. Timeline & Effort

---

#### 9.2 Present to User

```markdown
ðŸ“‹ PHASE 2 COMPLETE: Technical Planning

## Summary

**Feature:** Social Media Sharing
**Architecture:** Defined (3-tier)
**Components:** 15 components identified
**APIs:** 3 YOUR endpoints, 2 external
**Effort Estimate:** 8 days implementation

## Key Technical Decisions

âœ… React Native with TypeScript
âœ… Zustand for state (lightweight)
âœ… React Hook Form for forms (performant)
âœ… React Query for API (caching)
âœ… Keychain for tokens (secure)

## Architecture Highlights

- Modular component design
- Service layer for business logic
- Retry logic with exponential backoff
- Image compression (< 5MB target)
- Offline draft support

## Risks Addressed

âš ï¸ Facebook rate limits â†’ Exponential backoff
âš ï¸ Large images â†’ Client-side compression
âš ï¸ Token expiry â†’ Auto-refresh

## Deliverables Generated

- [x] tech_spec.md (15 pages)
- [x] architecture_diagram.drawio
- [x] lld.md (Low-Level Design)
- [x] api_contracts.md

---

ðŸ‘‰ **Ready to proceed to Phase 3: Design Review?**

Type:
- "approve" to continue
- "reject" + feedback to revise
- "clarify" + questions
```

---

## ðŸ‘¥ Cross-Review Process

**IMPORTANT:** Before presenting to user, technical plan must be reviewed by other agents.

### Review Workflow

```markdown
Step 1: Lead Dev Agent completes tech spec
   â†“
Step 2: Secondary Dev Agent Architecture Review (15-20 min)
   â†“
Step 3: QA Agent Test Planning Feasibility Review (10-15 min)
   â†“
Step 4: Lead Dev Agent consolidates feedback & updates
   â†“
Step 5: Present to User for approval
```

### Secondary Dev Review

**Second Dev Agent reviews for:**
- âœ… Architecture quality
- âœ… Code quality & best practices
- âœ… Maintainability
- âœ… Integration & dependencies
- âœ… Alternative approaches
- âš ï¸ Technical concerns

**Example: If mobile-react-native is primary, web-reactjs or backend-laravel reviews**

**Output:** Architecture review checklist (see `rules/cross-review-workflow.md`)

### QA Test Planning Feasibility Review

**QA Agent reviews for:**
- âœ… Testability of components
- âœ… Test isolation possibility
- âœ… Mocking strategy clarity
- âœ… Unit testing feasibility
- âœ… Integration testing approach
- âœ… E2E testing possibility
- âœ… Coverage target achievability
- âš ï¸ Testing concerns

**Output:** Test feasibility review checklist

### Consolidated Feedback Format

```markdown
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘  Phase 2: Technical Planning - Review Complete           â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

## Review Summary

**Primary Author:** mobile-react-native  
**Reviewers:** 2  
**Status:** âœ… 2 Approved

---

### 1. Secondary Dev Review (web-reactjs)
**Status:** âœ… Approved  
**Key Points:**
- Architecture is well-designed
- Component separation is logical
- State management with Zustand is appropriate
- API integration approach is sound

**Suggestions:**
- Consider extracting share logic to composable
- Add error boundary for share failures

**Concerns:** None

---

### 2. QA Feasibility Review (qa-automation)
**Status:** âœ… Approved  
**Key Points:**
- Components are highly testable
- Clear mocking strategy for APIs
- TDD approach will work well
- Can achieve 85% coverage target

**Test Strategy Notes:**
- Mock OAuth flows for unit tests
- Use MSW for API integration tests
- Detox for E2E testing
- Test both phone and tablet variants

**Concerns:** None

---

## Consolidated Feedback

**Updates Made:**
- âœ… Extracted `useSocialShare` composable
- âœ… Added error boundary component
- âœ… Updated test strategy in tech spec

**Acknowledged:**
- All reviewers approved architecture
- Test feasibility confirmed

---

## Updated Technical Plan

[Lead Dev Agent updates tech spec with feedback]

âœ‹ **APPROVAL REQUIRED**: Phase 2 Complete with Reviews

**Deliverables:**
- âœ… PHASE_2_TECH_SPEC.md (updated)
- âœ… architecture_diagram.drawio
- âœ… Secondary Dev Architecture Review
- âœ… QA Test Feasibility Review

**Next Phase:** Design Review (Phase 3) or Test Planning (Phase 4)

**Options:**
- "approve" â†’ Proceed to next phase
- "reject: [reason]" â†’ Revise technical plan
- "modify: [changes]" â†’ Make specific adjustments
```

---

## âœ… Phase 2 Checklist

### Architecture âœ…
- [ ] System architecture designed
- [ ] Component tree defined
- [ ] Data flow documented
- [ ] Diagrams created

### Technical Specs âœ…
- [ ] Technology stack chosen
- [ ] API contracts defined
- [ ] Data models specified
- [ ] Security considered

### Documentation âœ…
- [ ] Tech spec complete
- [ ] LLD document created
- [ ] Architecture diagrams
- [ ] Effort estimated

### Cross-Review âœ…
- [ ] **Secondary dev agent review completed**
- [ ] **QA test feasibility review completed**
- [ ] **All feedback addressed**
- [ ] **Reviews documented**

### Quality âœ…
- [ ] Performance considerations
- [ ] Security review
- [ ] User approval obtained

---

## ðŸš« Common Mistakes

### âŒ Don't:
- Over-engineer (YAGNI principle)
- Ignore non-functional requirements
- Skip error handling design
- Miss performance targets
- Forget security
- Design without Phase 1 context

### âœ… Do:
- Keep it simple
- Design for testability
- Plan for errors
- Consider performance early
- Security by design
- Reference Phase 1 requirements

---

**Phase 2 Complete! Ready for Phase 3: Design Review** ðŸŽ¨

