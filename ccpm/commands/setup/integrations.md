# Command: setup:integrations

**Purpose:** Interactive setup for Jira, Confluence, Slack, and Figma integrations

**Category:** Setup

**Usage:**
```
setup:integrations
```

---

## ğŸ“‹ Execution

When you run this command, Claude will execute:
```bash
bash scripts/setup-integrations.sh
```

This script will:
1. âœ… Check prerequisites (shell, direnv, existing config)
2. âœ… Install direnv (if not installed) - prompts for permission
3. âœ… **Interactive prompts** - asks for each integration's credentials
4. âœ… Generate `.envrc` with your inputs
5. âœ… Update `.gitignore` to ignore secrets
6. âœ… Create/update project `.envrc` to load CCPM config
7. âœ… Allow direnv and reload variables
8. âœ… Test all configured integrations

**IMPORTANT:** 
- All secrets stay in `.envrc` (git-ignored)
- Main project gets clean `.envrc` (no secrets, can commit)
- Fully interactive - you input values when prompted

---

## ğŸ”„ Workflow

### Phase 1: Check Prerequisites

**Steps:**
1. Check if direnv is installed
2. Check shell configuration
3. Check if `.envrc` exists

**Output:**
```markdown
## Prerequisites Check

âœ… Shell: zsh detected
âŒ direnv: Not installed
â„¹ï¸  .envrc: Not found

Next: Install direnv
```

---

### Phase 2: Install direnv (Optional)

**If direnv not installed:**

```markdown
## Install direnv

direnv allows automatic loading of environment variables
when you enter the project directory.

Do you want to install direnv?
Options:
- "yes" â†’ Install direnv automatically
- "skip" â†’ Skip installation (manual setup required)
```

**If user approves:**
- Detects OS (macOS, Linux, Windows)
- Runs appropriate install command
- Adds hook to shell config
- Verifies installation

**Auto-runs:**
```bash
# macOS
brew install direnv

# Linux (Ubuntu/Debian)
sudo apt-get install direnv

# Linux (Arch)
sudo pacman -S direnv
```

**Adds to shell config:**
```bash
# For zsh
echo 'eval "$(direnv hook zsh)"' >> ~/.zshrc

# For bash
echo 'eval "$(direnv hook bash)"' >> ~/.bashrc
```

---

### Phase 3: Create `.envrc`

**Interactive Configuration:**

```markdown
## Configure Integrations

I'll guide you through setting up each integration.
You can skip any integration by typing "skip".

Press Enter to continue...
```

#### 3.1: Jira Configuration

```markdown
### Jira Integration

Jira URL (e.g., https://company.atlassian.net):
> [user input]

Jira Email:
> [user input]

Jira API Token (get from: https://id.atlassian.com/manage-profile/security/api-tokens):
> [user input - hidden]

Jira Project Key (e.g., PROJ, PROJ):
> [user input]

âœ… Jira configured!
```

#### 3.2: Confluence Configuration

```markdown
### Confluence Integration

Use same credentials as Jira? (yes/no):
> yes

Confluence Space Key (e.g., TECH):
> [user input]

âœ… Confluence configured!
```

#### 3.3: Slack Configuration

```markdown
### Slack Integration

Choose setup method:
1. Bot Token (recommended - more features)
2. Webhook URL (simpler - notifications only)
3. Skip

> [user input: 1, 2, or 3]

[If 1 - Bot Token]
Slack Bot Token (get from: https://api.slack.com/apps):
> [user input - hidden]

Slack Channel ID:
> [user input]

[If 2 - Webhook]
Slack Webhook URL:
> [user input - hidden]

âœ… Slack configured!
```

#### 3.4: Figma Configuration

```markdown
### Figma Integration

Figma Personal Access Token (get from: Figma â†’ Settings â†’ Personal access tokens):
> [user input - hidden]

Default Figma File Key (optional, press Enter to skip):
> [user input or Enter]

âœ… Figma configured!
```

---

### Phase 4: Generate `.envrc`

**Creates file with user input:**

```bash
# .envrc - CCPM Integration Configuration
# Auto-generated by setup:integrations command
# Date: 2025-11-25

# ============================================
# Jira Integration
# ============================================
export JIRA_URL="https://company.atlassian.net"
export JIRA_EMAIL="user@company.com"
export JIRA_API_TOKEN="***"
export JIRA_PROJECT_KEY="PROJ"
export JIRA_DEFAULT_PRIORITY="Medium"

# ============================================
# Confluence Integration
# ============================================
export CONFLUENCE_URL="https://company.atlassian.net/wiki"
export CONFLUENCE_EMAIL="$JIRA_EMAIL"
export CONFLUENCE_API_TOKEN="$JIRA_API_TOKEN"
export CONFLUENCE_SPACE_KEY="TECH"
export CONFLUENCE_DEFAULT_LABELS="ccpm,generated,documentation"

# ============================================
# Slack Integration
# ============================================
export SLACK_BOT_TOKEN="***"
export SLACK_CHANNEL_ID="C1234567890"

# ============================================
# Figma Integration
# ============================================
export FIGMA_ACCESS_TOKEN="***"
export FIGMA_MCP_ENABLED="true"

# ============================================
# CCPM Configuration
# ============================================
export CCPM_AUTO_APPROVE="true"
export CCPM_DEFAULT_COVERAGE="80"
export CCPM_TDD_ENFORCE="true"
export CCPM_AUTO_NOTIFY="true"
```

**Updates `.gitignore`:**
```bash
# Add to .gitignore
.envrc
.envrc.local
*.env
```

---

### Phase 5: Setup direnv for `.envrc`

**Create `.envrc` loader:**

The trick is to use direnv to load environment variables from `.envrc`.

**In project root, create `.envrc` (if doesn't exist):**
```bash
# .envrc - Load CCPM integrations
# This file can be committed (no secrets)

# Load CCPM integration config
if [ -f .envrc ]; then
  source_env .envrc
fi

# Your other project env vars can go here
```

**Or append to existing `.envrc`:**
```bash
# Append to existing .envrc
echo "" >> .envrc
echo "# CCPM Integration" >> .envrc
echo "if [ -f .envrc ]; then" >> .envrc
echo "  source_env .envrc" >> .envrc
echo "fi" >> .envrc
```

---

### Phase 6: Allow direnv

**Auto-run:**
```bash
# Allow direnv to load .envrc
direnv allow .

# Reload shell
source ~/.zshrc  # or ~/.bashrc
```

**Output:**
```markdown
## direnv Configuration Complete

âœ… .envrc created
âœ… Project .envrc updated to load CCPM config
âœ… direnv allowed

Environment variables will auto-load when you:
- cd into this project
- Open new terminal in this project
```

---

### Phase 7: Test Integrations

**Auto-run test script:**
```bash
./scripts/test-integrations.sh
```

**Output:**
```markdown
## Testing Integrations

ğŸ§ª CCPM Integration Tests
==========================

Testing Jira connection... âœ… PASSED
Testing Confluence connection... âœ… PASSED
Testing Slack webhook... âœ… PASSED
Testing Figma connection... âœ… PASSED

==========================
Test Summary
==========================
Passed: 4
Failed: 0

âœ… All configured integrations working!
```

---

### Phase 8: Update Auto-Approval Settings

**Adds to `settings.local.json`:**
```json
{
  "permissions": {
    "allow": [
      "# direnv commands",
      "Bash(brew install direnv:*)",
      "Bash(sudo apt-get install direnv:*)",
      "Bash(direnv allow:*)",
      "Bash(direnv reload:*)",
      "Bash(source ~/.zshrc:*)",
      "Bash(source ~/.bashrc:*)",
      
      "# Integration test",
      "Bash(./scripts/test-integrations.sh:*)"
    ]
  }
}
```

---

## ğŸ“ File Structure After Setup

```
project/
â”œâ”€â”€ .envrc                    # Loads .envrc (can commit)
â”‚   â””â”€â”€ "source_env .envrc"
â”‚
â””â”€â”€ ccpm/
    â”œâ”€â”€ .envrc                # CCPM integrations (git-ignored)
    â”‚   â””â”€â”€ Contains: JIRA_*, CONFLUENCE_*, SLACK_*, FIGMA_*
    â”‚
    â”œâ”€â”€ .gitignore            # Updated to ignore .envrc
    â”‚   â””â”€â”€ Added: .envrc, *.env
    â”‚
    â””â”€â”€ settings.local.json   # Updated with direnv permissions
```

**Key Points:**
- âœ… Main project folder: Only `.envrc` (no secrets, can commit)
- âœ… All secrets in: `.envrc` (git-ignored)
- âœ… Portable: Copy `.envrc` to new machine, run setup again

---

## ğŸ¯ Command Options

### Full Setup (Default)
```bash
setup:integrations
```
- Installs direnv
- Configures integrations
- Tests connections

### Skip Installation
```bash
setup:integrations --skip-install
```
- Assumes direnv already installed
- Only configures integrations

### Test Only
```bash
setup:integrations --test-only
```
- Only runs integration tests
- Assumes already configured

### Reconfigure
```bash
setup:integrations --reconfigure
```
- Keeps existing values as defaults
- Allows updating specific values

---

## ğŸ”’ Security Features

### 1. Secrets Stay in `.envrc`
- âœ… `.envrc` is git-ignored
- âœ… Main `.envrc` contains no secrets
- âœ… Safe to commit project `.envrc`

### 2. Token Masking
```markdown
Current Jira API Token: *** (hidden)
Enter new token or press Enter to keep: 
```

### 3. Validation
- âœ… Validates URL formats
- âœ… Validates email formats
- âœ… Tests tokens immediately

### 4. Backup
```bash
# Before reconfiguring
cp .envrc .envrc.backup
```

---

## ğŸ¨ Usage Examples

### Example 1: First-time Setup

```bash
User: setup:integrations

AI:
## Prerequisites Check
âœ… Shell: zsh
âŒ direnv: Not installed

Install direnv? â†’ yes

[Installing direnv...]
âœ… direnv installed

## Configure Integrations

### Jira Integration
URL: https://company.atlassian.net
Email: dev@company.com
Token: *** [entered]
Project Key: PROJ
âœ… Jira configured

### Confluence Integration
Use Jira credentials? yes
Space Key: TECH
âœ… Confluence configured

### Slack Integration
Method: 1 (Bot Token)
Token: *** [entered]
Channel: C1234567890
âœ… Slack configured

### Figma Integration
Token: *** [entered]
âœ… Figma configured

## Testing Integrations
âœ… All 4 integrations working!

âœ… Setup Complete!
```

### Example 2: Reconfigure Slack Only

```bash
User: setup:integrations --reconfigure

AI:
## Reconfigure Integrations

Current configuration:
- Jira: âœ… Configured
- Confluence: âœ… Configured
- Slack: âœ… Configured
- Figma: âœ… Configured

Which integration to update?
1. Jira
2. Confluence
3. Slack
4. Figma
5. All

> 3

### Slack Integration
Current: Bot Token (***@company)
1. Keep current
2. Update token
3. Switch to webhook
4. Remove

> 2

New Slack Bot Token: *** [entered]
âœ… Slack updated

## Testing Slack
âœ… Slack connection working!
```

---

## ğŸš€ Auto-Continue

After setup completes:
- âœ… Shows summary of configured integrations
- âœ… Shows next steps
- âœ… Offers to start first workflow

```markdown
## Setup Complete! ğŸ‰

**Configured Integrations:**
- âœ… Jira (PROJ)
- âœ… Confluence (TECH space)
- âœ… Slack (#engineering)
- âœ… Figma

**Next Steps:**
1. Try: workflow:start PROJ-1234
2. Try: bugfix "Bug description"
3. Try: document feature "Feature name"

Start your first workflow now? (yes/no)
```

---

## ğŸ“‹ Troubleshooting

### direnv Not Loading

**Auto-fix:**
```bash
# Check hook installed
grep direnv ~/.zshrc

# Add if missing
echo 'eval "$(direnv hook zsh)"' >> ~/.zshrc

# Reload
source ~/.zshrc

# Allow
direnv allow .
```

### Variables Not Available

**Auto-check:**
```bash
# Test if loaded
echo $JIRA_URL

# If empty, reload
direnv reload

# Or restart shell
exec $SHELL
```

### Integration Test Fails

**Auto-debug:**
```bash
# Show current values (masked)
echo "JIRA_URL: $JIRA_URL"
echo "JIRA_EMAIL: $JIRA_EMAIL"
echo "JIRA_API_TOKEN: ${JIRA_API_TOKEN:0:4}***"

# Test manually
curl -u "$JIRA_EMAIL:$JIRA_API_TOKEN" "$JIRA_URL/rest/api/3/myself"
```

---

## âœ… Success Criteria

**Setup succeeds when:**
- âœ… direnv installed and configured
- âœ… `.envrc` created with secrets
- âœ… Project `.envrc` loads CCPM config
- âœ… direnv allowed
- âœ… All integrations tested and working
- âœ… Auto-approval updated
- âœ… User can run `workflow:start PROJ-1234`

---

## ğŸ¯ Benefits

**vs Manual Setup:**
- âš¡ 10x faster (2 min vs 20 min)
- âœ… Guided (no docs reading needed)
- âœ… Validated (tests each integration)
- âœ… Secure (proper file structure)
- âœ… Portable (easy to replicate)

**Security:**
- âœ… Secrets in `.envrc` only
- âœ… Main project clean
- âœ… Safe to commit `.envrc`
- âœ… Team-friendly

---

## ğŸ“ Template Used

- `.envrc.template` - Internal template
- Project `.envrc` - Minimal loader

---

**ğŸŠ One command setup for all integrations! ğŸš€âœ¨**

